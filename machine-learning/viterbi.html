<html>
<head>
</head>
<body>
<div>
    <p>
        <label for="input">Sy√∂te</label>
        <input type="text"  size="100" maxlength="150" id="input"><br/>
       Tulos:  <span id="output" />
    </p>
</div>

</body>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/bacon.js/0.7.0/Bacon.min.js"></script>
<script type='text/javascript'>

    function createViterbi(states, transitions, observationFunction, initialProbabilities) {

        return function viterbi(accumulator, observation) {
            if (accumulator.path.length < 1) {
                var path = [], viterbi = [];
                for (var state = 0; state < states; state = state + 1) {
                    path.push([state]);
                    viterbi.push(initialProbabilities[state] * observationFunction(observation, state));
                }
                return {path: path, viterbi: viterbi};
            }
            var newPath = [];
            for (var j = 0; j < states; j = j + 1) { // loop over next state
                var survivor = { index: -1, probability: -1 };
                for (var i = 0; i < states ; i = i + 1) { // loop over source state
                    var probability = accumulator.viterbi[i] * transitions[i][j] * observationFunction(observation, j);
                    if (probability > survivor.probability) {
                        survivor.index = i;
                        survivor.probability = probability;
                    }
                }
                accumulator.viterbi[j] = survivor.probability;
                newPath[j] = accumulator.path[survivor.index].slice();
                newPath[j].push(j);
            }
            return {path: newPath, viterbi: accumulator.viterbi};
        }
    }

    function conclude(viterbiAccumulator) {
        var best = { index: -1, probability: -1 };
        $.each(viterbiAccumulator.viterbi, function(state, probability) {
            if (probability > best.probability) {
                best.index = state;
                best.probability = probability;
            }
        });
        var result = '';
        $.each(viterbiAccumulator.path[best.index], function(_, val) {
            result = result + String.fromCharCode(val + 65);
        })
        return result;
    }

    $(document).ready(function() {
        var transitions = [[0.8, 0.1, 0.1],
                           [0.05, 0.9, 0.05],
                           [0.3, 0.05, 0.65]],
            initialProbabilities = [0.4, 0.4, 0.2],
            states = transitions.length;

        var observationFunction = function(observation, state) {
            var smoothing = 0.1;
            if (observation === state) {
                return 1 - smoothing;
            } else {
                return smoothing / (states - 1);
            }
        }
        var keyCodeToState = function(val) {
            var aAsZero = val - 65;
            return aAsZero < 0 || aAsZero > 1 ? 2 : aAsZero;
        }

        var viterbi = createViterbi(states, transitions, observationFunction, initialProbabilities);

        var viterbiAccumulator = $('#input')
                .asEventStream('keyup')
                .map('.keyCode')
                .map(keyCodeToState)
                .scan({path: []}, viterbi);

        viterbiAccumulator.log();

        viterbiAccumulator
                .filter(function(x) {return x.viterbi})
                .map(conclude)
                .assign($("#output"), "text");

    });
</script>
</html>

